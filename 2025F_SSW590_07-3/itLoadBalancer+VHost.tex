\chapter{Load Balancer and Virtual Hosting \\
\small{\textit{-- Luo Xu, Gavin Lam}}
\index{Load Balancer and Virtual Machine} 
\index{Chapter!Load Balancer and Virtual Machine}
\label{Chapter::Load Balancer and Virtual Machine}}

\section{Introduction}
This document provides detailed documentation of the set up for Load Balancer and Virtual Machine via Droplet with Docker.

\section{Part 1: Loan Balancer}
The directory was set up with the app as the root, the docker-compose.yml file, the nginx directory with the nginx.conf file, web1 directory and index.html, and the web2 and index.html.

web1/index.html:
\begin{minted}{html}
    <h1>Hello from Web 1 </h1>
\end{minted}

web2/index.html:
\begin{minted}{html}
    <h1>Hello from Web 2 </h1>
\end{minted}

nginx/nginx.conf:
\begin{minted}{bash}
# /root/load-balanced-app/nginx/nginx.conf
upstream backend {
        server web1:80;
        server web2:80;
}

server {
        listen 80;
        location / {
                proxy_pass http://backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
}
\end{minted}

docker-compose.yml:
\begin{minted}{yaml}
version: '3'

services:
  web1:
    image:  nginx
    container_name: web1
    volumes:
      - ./web1:/usr/share/nginx/html:ro

  web2:
    image: nginx
    container_name: web2
    volumes:
      - ./web2/:/usr/share/nginx/html:ro

  loadbalancer:
    image: nginx
    container_name: loadbalancer
    ports:
      - "8080:80"
    volumes:
      - /root/load-balanced-app/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web1
      - web2
\end{minted}

We then ran:
\begin{minted}{bash}
    docker-compose up --build
\end{minted}

for it to build, and we tested with the command:
\begin{minted}{bash}
    curl -s http://localhost:8080
\end{minted}
a couple of times and watched it alternate between 
\begin{minted}{html}
<h1>Hello from Web 1 </h1>
<h1>Hello from Web 2 </h1> 
\end{minted}

We ran into the issue of when we visited the site it failed to connect, to fix that, we went to digital ocean and added a new TCP protocol for 8080, and after that we were able to see the site alternating when refreshed:

\begin{figure}
      \centering
      \includegraphics[width=1\linewidth]{png/Web1.png}
      \includegraphics[width=1\linewidth]{png/Web2.png}
      \caption{switching between web1 and web2 on: http://174.138.68.199:8080/}
      \label{fig:placeholder}
\end{figure}
Verifying that our load balancer is working.

\section{Part 2: Virtual Host}
For this we added the vhost.config file:
\begin{minted}{bash}
\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{png/balance_vhost}
    \caption{Enter Caption}
    \label{fig:placeholder}
\end{figure}
events { }

http {
        server {
                listen 80;
                server_name web1.domain.com;
                location / {
                        proxy_pass http://web1:80;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                }
        }

        server {
                listen 80;
                server_name web2.domain.com;
                location / {
                        proxy_pass http://web2:80;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                }
        }
}
\end{minted}

and added an lb.conf file:
\begin{minted}{bash}
upstream backend {
  server web1:80;
  server web2:80;
}

server {
  listen 80;
  location / {
    proxy_pass http://backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}

\end{minted}
and then compose and check for usage in the droplet with commands and receiving these back: 
\begin{figure}
      \centering
      \includegraphics[width=1\linewidth]{png/balance_vhost.png}
      \caption{verifying that both our load balancer and vhost is working}
      \label{fig:placeholder}
\end{figure}
